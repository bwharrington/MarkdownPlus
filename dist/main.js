(()=>{"use strict";var e={157:e=>{e.exports=require("electron")},530:function(e,n,t){var i,o=this&&this.__createBinding||(Object.create?function(e,n,t,i){void 0===i&&(i=t);var o=Object.getOwnPropertyDescriptor(n,t);o&&!("get"in o?!n.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return n[t]}}),Object.defineProperty(e,i,o)}:function(e,n,t,i){void 0===i&&(i=t),e[i]=n[t]}),r=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),l=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var n=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[n.length]=t);return n},i(e)},function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t=i(e),l=0;l<t.length;l++)"default"!==t[l]&&o(n,e,t[l]);return r(n,e),n}),s=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(o,r){function l(e){try{a(i.next(e))}catch(e){r(e)}}function s(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(l,s)}a((i=i.apply(e,n||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0}),n.initLogger=function(){const e=d.app.isPackaged?c.dirname(d.app.getPath("exe")):d.app.getAppPath();u=c.join(e,"markdownplus-debug.log");try{a.writeFile(u,"=== MarkdownPlus Debug Log ===\n","utf-8").catch((()=>{}))}catch(e){}p("Logger initialized",{appPath:e,logFilePath:u,isPackaged:d.app.isPackaged})},n.log=p,n.logError=function(e,n){const t=(new Date).toISOString(),i=Object.assign({message:(null==n?void 0:n.message)||String(n),stack:null==n?void 0:n.stack},n),o=`[${t}] ERROR: ${e}\n${JSON.stringify(i,null,2)}\n\n`;console.error(`[ERROR] ${e}`,n),f.push(o),setTimeout(h,100)},n.flushLogsSync=function(){return s(this,void 0,void 0,(function*(){yield h()}))},n.getLogFilePath=function(){return u};const a=l(t(943)),c=l(t(928)),d=t(157);let u,f=[],g=!1;function h(){return s(this,void 0,void 0,(function*(){if(g||0===f.length)return;g=!0;const e=[...f];f=[];try{yield a.appendFile(u,e.join(""),"utf-8")}catch(e){console.error("Failed to write logs:",e)}finally{g=!1}}))}function p(e,n){const t=(new Date).toISOString(),i=n?`[${t}] ${e}\n${JSON.stringify(n,null,2)}\n\n`:`[${t}] ${e}\n\n`;console.log(`[LOG] ${e}`,n||""),f.push(i),setTimeout(h,100)}},915:function(e,n,t){var i,o=this&&this.__createBinding||(Object.create?function(e,n,t,i){void 0===i&&(i=t);var o=Object.getOwnPropertyDescriptor(n,t);o&&!("get"in o?!n.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return n[t]}}),Object.defineProperty(e,i,o)}:function(e,n,t,i){void 0===i&&(i=t),e[i]=n[t]}),r=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),l=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var n=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[n.length]=t);return n},i(e)},function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t=i(e),l=0;l<t.length;l++)"default"!==t[l]&&o(n,e,t[l]);return r(n,e),n}),s=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(o,r){function l(e){try{a(i.next(e))}catch(e){r(e)}}function s(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(l,s)}a((i=i.apply(e,n||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0});const a=t(157),c=l(t(928)),d=l(t(943)),u=t(530);let f,g=[];const h=()=>{const e=a.app.isPackaged?c.dirname(a.app.getPath("exe")):a.app.getAppPath();return c.join(e,"config.json")},p={recentFiles:[],openFiles:[],defaultLineEnding:"CRLF",devToolsOpen:!1};function v(e){return e.includes("\r\n")?"CRLF":"LF"}function y(e,n){const t=e.replace(/\r\n/g,"\n");return"CRLF"===n?t.replace(/\n/g,"\r\n"):t}function m(){return s(this,void 0,void 0,(function*(){try{const e=h(),n=yield d.readFile(e,"utf-8");return Object.assign(Object.assign({},p),JSON.parse(n))}catch(e){return p}}))}function w(e){return s(this,void 0,void 0,(function*(){try{const n=h();yield d.writeFile(n,JSON.stringify(e,null,2),"utf-8")}catch(e){console.error("Failed to save config:",e)}}))}a.app.whenReady().then((()=>s(void 0,void 0,void 0,(function*(){(0,u.initLogger)(),(0,u.log)("=== App Starting ==="),(0,u.log)("Electron app ready");const e=process.argv.slice(1);(0,u.log)("Command line arguments received",{args:e,length:e.length}),g=e.filter((e=>{const n=e.toLowerCase(),t=n.endsWith(".md")||n.endsWith(".markdown"),i=!e.startsWith("--")&&!e.startsWith("-"),o=t&&i;return(0,u.log)("Filtering argument",{arg:e,lowerArg:n,isMarkdown:t,isNotFlag:i,included:o}),o})),(0,u.log)("Pending files to open after filtering",{pendingFilesToOpen:g,count:g.length}),(0,u.log)("Registering IPC handlers"),function(){a.ipcMain.handle("file:open",(()=>s(this,void 0,void 0,(function*(){const e=yield a.dialog.showOpenDialog(f,{filters:[{name:"Markdown",extensions:["md","markdown"]},{name:"Text Files",extensions:["txt"]},{name:"All Files",extensions:["*"]}],properties:["openFile","multiSelections"]});if(e.canceled||0===e.filePaths.length)return null;const n=[];for(const t of e.filePaths)try{const e=yield d.readFile(t,"utf-8"),i=v(e);n.push({filePath:t,content:e,lineEnding:i})}catch(e){console.error(`Failed to read file ${t}:`,e)}return n.length>0?n:null})))),a.ipcMain.handle("file:read",((e,n)=>s(this,void 0,void 0,(function*(){(0,u.log)("IPC: file:read called",{filePath:n});try{const e=yield d.readFile(n,"utf-8"),t=v(e);return(0,u.log)("IPC: file:read success",{filePath:n,contentLength:e.length,lineEnding:t}),{filePath:n,content:e,lineEnding:t}}catch(e){return(0,u.logError)("IPC: file:read failed",e),null}})))),a.ipcMain.handle("file:save",((e,n,t)=>s(this,void 0,void 0,(function*(){try{let e="LF";try{e=v(yield d.readFile(n,"utf-8"))}catch(n){e="win32"===process.platform?"CRLF":"LF"}const i=y(t,e);return yield d.writeFile(n,i,"utf-8"),{success:!0,filePath:n}}catch(e){return console.error("Failed to save file:",e),{success:!1,filePath:n,error:String(e)}}})))),a.ipcMain.handle("file:save-as",((e,n,t)=>s(this,void 0,void 0,(function*(){const e=yield a.dialog.showSaveDialog(f,{defaultPath:t||"Untitled.md",filters:[{name:"Markdown",extensions:["md"]},{name:"Text Files",extensions:["txt"]},{name:"All Files",extensions:["*"]}]});if(e.canceled||!e.filePath)return null;try{const t="win32"===process.platform?"CRLF":"LF",i=y(n,t);return yield d.writeFile(e.filePath,i,"utf-8"),{success:!0,filePath:e.filePath}}catch(n){return console.error("Failed to save file:",n),{success:!1,filePath:e.filePath,error:String(n)}}})))),a.ipcMain.handle("file:rename",((e,n,t)=>s(this,void 0,void 0,(function*(){try{return yield d.rename(n,t),{success:!0}}catch(e){throw console.error("Failed to rename file:",e),e}})))),a.ipcMain.handle("config:load",(()=>s(this,void 0,void 0,(function*(){return yield m()})))),a.ipcMain.handle("config:save",((e,n)=>s(this,void 0,void 0,(function*(){yield w(n)})))),a.ipcMain.handle("config:open",(()=>s(this,void 0,void 0,(function*(){return yield function(){return s(this,void 0,void 0,(function*(){const e=h();try{try{yield d.access(e)}catch(n){yield d.writeFile(e,JSON.stringify(p,null,2),"utf-8")}const n=yield d.readFile(e,"utf-8");return{filePath:e,content:n,lineEnding:v(n)}}catch(e){return console.error("Failed to open config file:",e),null}}))}()})))),a.ipcMain.handle("get-initial-files",(()=>{(0,u.log)("IPC: get-initial-files called",{pendingFiles:g});const e=g;return g=[],(0,u.log)("IPC: Returning files and clearing pending",{files:e}),e})),a.ipcMain.handle("renderer-ready",(()=>{if((0,u.log)("IPC: renderer-ready called",{pendingFiles:g}),g.length>0&&f&&!f.isDestroyed()){(0,u.log)("Sending files to renderer after ready signal",{files:g}),f.webContents.send("open-files-from-args",g),(0,u.log)('IPC event "open-files-from-args" sent to renderer');const e=[...g];return g=[],(0,u.log)("Returning files from renderer-ready",{files:e}),e}return(0,u.log)("No files to send from renderer-ready"),[]})),a.ipcMain.handle("config:sync-recent-files",((e,n)=>s(this,void 0,void 0,(function*(){const e=yield m(),t=Object.assign(Object.assign({},e),{recentFiles:n,openFiles:n});yield w(t)})))),a.ipcMain.handle("dialog:confirm-close",((e,n)=>s(this,void 0,void 0,(function*(){return{action:["save","discard","cancel"][(yield a.dialog.showMessageBox(f,{type:"question",buttons:["Save","Don't Save","Cancel"],defaultId:0,cancelId:2,title:"Unsaved Changes",message:`Do you want to save changes to "${n}"?`,detail:"Your changes will be lost if you don't save them."})).response]}})))),a.ipcMain.handle("devtools:toggle",(()=>s(this,void 0,void 0,(function*(){return!(!f||f.isDestroyed()||(f.webContents.isDevToolsOpened()?(f.webContents.closeDevTools(),1):(f.webContents.openDevTools(),0)))})))),a.ipcMain.handle("devtools:get-state",(()=>s(this,void 0,void 0,(function*(){return!(!f||f.isDestroyed())&&f.webContents.isDevToolsOpened()})))),a.ipcMain.handle("log:get-path",(()=>(0,u.getLogFilePath)())),a.ipcMain.on("console:log",((e,n,...t)=>{const i=t.map((e=>"object"==typeof e?JSON.stringify(e):String(e))).join(" ");(0,u.log)(`[RENDERER ${n.toUpperCase()}] ${i}`)})),a.ipcMain.handle("dialog:external-change",((e,n)=>s(this,void 0,void 0,(function*(){return 0===(yield a.dialog.showMessageBox(f,{type:"question",buttons:["Reload","Keep Current"],defaultId:0,title:"File Changed",message:`"${n}" has been modified externally.`,detail:"Do you want to reload the file or keep your current version?"})).response?"reload":"keep"})))),a.ipcMain.handle("window:set-title",((e,n)=>s(this,void 0,void 0,(function*(){null==f||f.setTitle(n)})))),a.ipcMain.handle("window:get-bounds",(()=>s(this,void 0,void 0,(function*(){return null==f?void 0:f.getBounds()})))),a.ipcMain.handle("window:minimize",(()=>s(this,void 0,void 0,(function*(){null==f||f.minimize()})))),a.ipcMain.handle("window:maximize",(()=>s(this,void 0,void 0,(function*(){(null==f?void 0:f.isMaximized())?f.unmaximize():null==f||f.maximize()})))),a.ipcMain.handle("window:close",(()=>s(this,void 0,void 0,(function*(){null==f||f.close()})))),a.ipcMain.handle("shell:show-in-folder",((e,n)=>s(this,void 0,void 0,(function*(){a.shell.showItemInFolder(n)}))))}(),a.Menu.setApplicationMenu(null),(0,u.log)("Creating main window"),function(){f=new a.BrowserWindow({width:1200,height:800,minWidth:600,minHeight:400,frame:!1,icon:c.join(__dirname,"assets","MarkdownPlus.png"),webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:c.join(__dirname,"preload.js")}}),f.loadFile(c.join(__dirname,"index.html")),m().then((e=>{e.devToolsOpen&&f&&!f.isDestroyed()&&((0,u.log)("Opening DevTools from config",{devToolsOpen:e.devToolsOpen}),f.webContents.openDevTools())})),f.webContents.on("devtools-opened",(()=>s(this,void 0,void 0,(function*(){(0,u.log)("DevTools opened via native UI");const e=yield m();yield w(Object.assign(Object.assign({},e),{devToolsOpen:!0}))})))),f.webContents.on("devtools-closed",(()=>s(this,void 0,void 0,(function*(){(0,u.log)("DevTools closed via native UI");const e=yield m();yield w(Object.assign(Object.assign({},e),{devToolsOpen:!1}))})))),f.on("closed",(()=>{f=null}))}(),(0,u.log)("Main window created")})))),a.app.on("second-instance",((e,n)=>{(0,u.log)("Second instance detected",{commandLine:n}),f&&(f.isMinimized()&&f.restore(),f.focus());const t=n.slice(1);(0,u.log)("Second instance args",{args:t});const i=t.filter((e=>{const n=e.toLowerCase(),t=n.endsWith(".md")||n.endsWith(".markdown"),i=!e.startsWith("--")&&!e.startsWith("-");return t&&i}));(0,u.log)("Second instance files to open",{filesToOpen:i}),i.length>0&&f&&!f.isDestroyed()&&((0,u.log)("Sending second instance files to renderer",{filesToOpen:i}),f.webContents.send("open-files-from-args",i))})),a.app.requestSingleInstanceLock()||a.app.quit(),a.app.on("before-quit",(()=>s(void 0,void 0,void 0,(function*(){(0,u.log)("App quitting, flushing logs"),yield(0,u.flushLogsSync)()}))))},928:e=>{e.exports=require("path")},943:e=>{e.exports=require("fs/promises")}},n={};!function t(i){var o=n[i];if(void 0!==o)return o.exports;var r=n[i]={exports:{}};return e[i].call(r.exports,r,r.exports,t),r.exports}(915)})();